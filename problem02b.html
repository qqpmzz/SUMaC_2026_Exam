<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUMaC 문제 2b - 동전 퍼즐 (8개)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .move-display {
            font-size: 2em;
            margin-bottom: 20px;
            color: #3498db;
            font-weight: bold;
        }

        .table-container {
            position: relative;
            width: 340px;
            height: 340px;
            margin-bottom: 25px;
        }

        .table {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(145deg, #8B4513, #654321);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3), inset 0 2px 10px rgba(255,255,255,0.1);
            transition: transform 0.8s ease;
        }

        .cup-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
        }

        .cup {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.5), 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate(-50%, -50%);
            cursor: default;
        }

        .cup.selectable {
            cursor: pointer;
        }

        .cup.selectable:hover {
            box-shadow: 0 0 10px 3px #9b59b6, inset 0 4px 10px rgba(0,0,0,0.5);
        }

        .cup.selected {
            box-shadow: 0 0 15px 5px #9b59b6, inset 0 4px 10px rgba(0,0,0,0.5);
        }

        .coin {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: default;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1em;
            border: 2px solid #888;
        }

        .coin.heads {
            background: linear-gradient(145deg, #ffffff, #e0e0e0);
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .coin.tails {
            background: linear-gradient(145deg, #2c2c2c, #1a1a1a);
            color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .coin.hidden {
            background: linear-gradient(145deg, #666, #444);
            color: transparent;
            cursor: default;
        }

        .coin.visible {
            cursor: pointer;
        }

        .coin.visible:hover {
            transform: scale(1.1);
        }

        .coin.flipping {
            animation: flip 0.3s ease;
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }

        .highlight {
            box-shadow: 0 0 15px 5px #3498db, inset 0 4px 10px rgba(0,0,0,0.5);
        }

        .highlight-you {
            box-shadow: 0 0 15px 5px #e74c3c, inset 0 4px 10px rgba(0,0,0,0.5);
        }

        .highlight-friend {
            box-shadow: 0 0 15px 5px #27ae60, inset 0 4px 10px rgba(0,0,0,0.5);
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 20px;
            font-size: 1em;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            background: #fff;
            color: #333;
            min-width: 100px;
        }

        .btn:hover:not(:disabled) {
            background: #333;
            color: #fff;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn.active {
            background: #3498db;
            color: #fff;
            border-color: #3498db;
        }

        .btn.spin-btn {
            background: #e74c3c;
            color: #fff;
            border-color: #e74c3c;
        }

        .btn.spin-btn:hover:not(:disabled) {
            background: #c0392b;
        }

        .btn.select-mode {
            background: #9b59b6;
            color: #fff;
            border-color: #9b59b6;
        }

        .btn.select-mode:hover:not(:disabled) {
            background: #8e44ad;
        }

        .legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .legend-color.you {
            background: #e74c3c;
            box-shadow: 0 0 5px #e74c3c;
        }

        .legend-color.friend {
            background: #27ae60;
            box-shadow: 0 0 5px #27ae60;
        }

        .status-message {
            font-size: 1em;
            color: #9b59b6;
            margin-bottom: 15px;
            font-weight: bold;
            min-height: 24px;
        }

        .win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .win-overlay.show {
            display: flex;
        }

        .win-message {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }

        .win-message h2 {
            color: #27ae60;
            font-size: 2em;
            margin-bottom: 15px;
        }

        .win-message p {
            color: #666;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="move-display"><span id="move-label">이동 횟수</span>: <span id="moves">0</span></div>

    <div class="table-container">
        <div class="table" id="table">
            <div class="cup-ring" id="cup-ring"></div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color you"></div>
            <span id="legend-you">나 (2개)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color friend"></div>
            <span id="legend-friend">친구 (2개)</span>
        </div>
    </div>

    <div class="status-message" id="status-message"></div>

    <div class="controls">
        <button class="btn" id="btn-view-all">전체보기</button>
        <button class="btn" id="btn-view-adjacent">인접보기</button>
        <button class="btn" id="btn-view-opposite">마주보기</button>
        <button class="btn" id="btn-view-custom">직접선택</button>
    </div>

    <div class="controls">
        <button class="btn spin-btn" id="btn-spin" disabled>돌리기 (R)</button>
        <button class="btn" id="btn-reset">초기화</button>
    </div>

    <div class="win-overlay" id="win-overlay">
        <div class="win-message">
            <h2>축하합니다!</h2>
            <p>모든 동전을 같은 색으로 만들었습니다!</p>
            <p>총 <span id="final-moves">0</span>번의 이동으로 성공했습니다.</p>
            <button class="btn" onclick="resetGame()">다시 하기</button>
        </div>
    </div>

    <script>
        const NUM_CUPS = 8;
        let coins = new Array(NUM_CUPS).fill(true);
        let visibleCoins = new Array(NUM_CUPS).fill(false);
        let moves = 0;
        let isSpinning = false;
        let hasViewed = false;
        let isSelectMode = false;
        let selectedCups = [];

        // 8개의 컵 위치 계산 (원형 배치)
        function getCupPosition(index) {
            const angle = (index * 45 - 90) * Math.PI / 180;
            const radius = 110;
            const centerX = 140;
            const centerY = 140;
            return {
                left: centerX + radius * Math.cos(angle),
                top: centerY + radius * Math.sin(angle)
            };
        }

        function createCups() {
            const cupRing = document.getElementById('cup-ring');
            cupRing.innerHTML = '';

            for (let i = 0; i < NUM_CUPS; i++) {
                const pos = getCupPosition(i);
                const cup = document.createElement('div');
                cup.className = 'cup';
                cup.setAttribute('data-index', i);
                cup.style.left = pos.left + 'px';
                cup.style.top = pos.top + 'px';
                cup.addEventListener('click', () => onCupClick(i));

                const coin = document.createElement('div');
                coin.className = 'coin hidden';
                coin.setAttribute('data-index', i);
                coin.textContent = '?';
                coin.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!isSelectMode) {
                        flipCoin(i);
                    } else {
                        onCupClick(i);
                    }
                });

                cup.appendChild(coin);
                cupRing.appendChild(cup);
            }
        }

        function init() {
            do {
                coins = [];
                for (let i = 0; i < NUM_CUPS; i++) {
                    coins.push(Math.random() < 0.5);
                }
            } while (coins.every(c => c === true) || coins.every(c => c === false));

            visibleCoins = new Array(NUM_CUPS).fill(false);
            moves = 0;
            isSpinning = false;
            hasViewed = false;
            isSelectMode = false;
            selectedCups = [];
            setStatusMessage('');
            render();
            updateSpinButton();
            clearHighlights();
            clearActiveButtons();
            updateCupsSelectable(false);
        }

        function render() {
            const coinElements = document.querySelectorAll('.coin');
            coinElements.forEach((el, idx) => {
                el.className = 'coin';

                if (visibleCoins[idx]) {
                    el.classList.add('visible');
                    if (coins[idx]) {
                        el.classList.add('heads');
                        el.textContent = 'H';
                    } else {
                        el.classList.add('tails');
                        el.textContent = 'T';
                    }
                } else {
                    el.classList.add('hidden');
                    el.textContent = '?';
                }
            });

            document.getElementById('moves').textContent = moves;
        }

        function updateSpinButton() {
            document.getElementById('btn-spin').disabled = !hasViewed || isSelectMode;
        }

        function clearHighlights() {
            document.querySelectorAll('.cup').forEach(cup => {
                cup.classList.remove('highlight', 'highlight-you', 'highlight-friend', 'selected');
            });
        }

        function clearActiveButtons() {
            document.querySelectorAll('.btn').forEach(btn => {
                if (btn.id !== 'btn-spin' && btn.id !== 'btn-reset') {
                    btn.classList.remove('active', 'select-mode');
                }
            });
        }

        function highlightCups(indices, type = 'highlight') {
            indices.forEach(idx => {
                document.querySelector(`.cup[data-index="${idx}"]`).classList.add(type);
            });
        }

        function setStatusMessage(msg) {
            document.getElementById('status-message').textContent = msg;
        }

        function updateCupsSelectable(selectable) {
            document.querySelectorAll('.cup').forEach(cup => {
                if (selectable) {
                    cup.classList.add('selectable');
                } else {
                    cup.classList.remove('selectable');
                }
            });
        }

        function onCupClick(idx) {
            if (!isSelectMode || isSpinning) return;

            const cup = document.querySelector(`.cup[data-index="${idx}"]`);

            if (selectedCups.includes(idx)) {
                // 이미 선택된 컵이면 선택 해제
                selectedCups = selectedCups.filter(i => i !== idx);
                cup.classList.remove('selected');
            } else if (selectedCups.length < 4) {
                // 4개 미만일 때만 추가 선택
                selectedCups.push(idx);
                cup.classList.add('selected');
            }

            const t = translations[currentLang];
            setStatusMessage(`${t.selected} ${selectedCups.length}${t.selectOf}`);
        }

        // 전체 8개 보기
        function viewAll() {
            if (isSpinning) return;
            exitSelectMode();
            visibleCoins = new Array(NUM_CUPS).fill(true);
            hasViewed = true;
            clearHighlights();
            highlightCups([0, 1, 2, 3], 'highlight-you');
            highlightCups([4, 5, 6, 7], 'highlight-friend');
            clearActiveButtons();
            document.getElementById('btn-view-all').classList.add('active');
            render();
            updateSpinButton();
            checkWin();
        }

        // 인접 4개 보기
        function viewAdjacent() {
            if (isSpinning) return;
            exitSelectMode();
            const startIdx = Math.floor(Math.random() * NUM_CUPS);
            visibleCoins = new Array(NUM_CUPS).fill(false);

            const indices = [];
            for (let i = 0; i < 4; i++) {
                indices.push((startIdx + i) % NUM_CUPS);
            }

            indices.forEach(idx => visibleCoins[idx] = true);
            hasViewed = true;
            clearHighlights();
            highlightCups([indices[0], indices[1]], 'highlight-you');
            highlightCups([indices[2], indices[3]], 'highlight-friend');
            clearActiveButtons();
            document.getElementById('btn-view-adjacent').classList.add('active');
            render();
            updateSpinButton();
            checkWin();
        }

        // 마주보기 (대칭 위치 4개)
        function viewOpposite() {
            if (isSpinning) return;
            exitSelectMode();
            const startIdx = Math.floor(Math.random() * 4);
            visibleCoins = new Array(NUM_CUPS).fill(false);

            // 0-4, 1-5, 2-6, 3-7이 마주보는 쌍
            const myIndices = [startIdx, (startIdx + 4) % NUM_CUPS];
            const friendIndices = [(startIdx + 2) % NUM_CUPS, (startIdx + 6) % NUM_CUPS];

            myIndices.forEach(idx => visibleCoins[idx] = true);
            friendIndices.forEach(idx => visibleCoins[idx] = true);

            hasViewed = true;
            clearHighlights();
            highlightCups(myIndices, 'highlight-you');
            highlightCups(friendIndices, 'highlight-friend');
            clearActiveButtons();
            document.getElementById('btn-view-opposite').classList.add('active');
            render();
            updateSpinButton();
            checkWin();
        }

        // 직접 선택 모드 토글
        function toggleCustomSelect() {
            if (isSpinning) return;

            if (isSelectMode) {
                // 선택 모드에서 확인 버튼 누름
                if (selectedCups.length === 4) {
                    confirmCustomSelect();
                } else {
                    setStatusMessage(translations[currentLang].pleaseSelect4);
                }
            } else {
                // 선택 모드 진입
                enterSelectMode();
            }
        }

        function enterSelectMode() {
            isSelectMode = true;
            selectedCups = [];
            visibleCoins = new Array(NUM_CUPS).fill(false);
            hasViewed = false;
            clearHighlights();
            clearActiveButtons();
            document.getElementById('btn-view-custom').classList.add('active', 'select-mode');
            document.getElementById('btn-view-custom').textContent = translations[currentLang].confirm;
            setStatusMessage(translations[currentLang].selectPrompt);
            updateCupsSelectable(true);
            render();
            updateSpinButton();
        }

        function exitSelectMode() {
            isSelectMode = false;
            selectedCups = [];
            document.getElementById('btn-view-custom').textContent = translations[currentLang].viewCustom;
            document.getElementById('btn-view-custom').classList.remove('select-mode');
            setStatusMessage('');
            updateCupsSelectable(false);
            clearHighlights();
        }

        function confirmCustomSelect() {
            if (selectedCups.length !== 4) return;

            isSelectMode = false;
            visibleCoins = new Array(NUM_CUPS).fill(false);
            selectedCups.forEach(idx => visibleCoins[idx] = true);
            hasViewed = true;

            clearHighlights();
            // 처음 2개: 나, 나머지 2개: 친구
            highlightCups([selectedCups[0], selectedCups[1]], 'highlight-you');
            highlightCups([selectedCups[2], selectedCups[3]], 'highlight-friend');

            document.getElementById('btn-view-custom').textContent = translations[currentLang].viewCustom;
            document.getElementById('btn-view-custom').classList.remove('select-mode');
            setStatusMessage('');
            updateCupsSelectable(false);

            render();
            updateSpinButton();
            checkWin();
        }

        function flipCoin(idx) {
            if (!visibleCoins[idx] || isSpinning || isSelectMode) return;

            const coinEl = document.querySelector(`.coin[data-index="${idx}"]`);
            coinEl.classList.add('flipping');

            setTimeout(() => {
                coins[idx] = !coins[idx];
                render();
                coinEl.classList.remove('flipping');
                checkWin();
            }, 150);
        }

        function spin() {
            if (isSpinning || !hasViewed || isSelectMode) return;

            isSpinning = true;
            moves++;

            visibleCoins = new Array(NUM_CUPS).fill(false);
            clearHighlights();
            clearActiveButtons();
            render();

            const table = document.getElementById('table');
            const rotations = Math.floor(Math.random() * NUM_CUPS);
            const visualRotation = 360 + rotations * 45 + Math.random() * 720;

            setTimeout(() => {
                table.style.transform = `rotate(${visualRotation}deg)`;
            }, 100);

            setTimeout(() => {
                if (rotations > 0) {
                    const newCoins = [...coins];
                    for (let i = 0; i < NUM_CUPS; i++) {
                        const newIdx = (i + rotations) % NUM_CUPS;
                        newCoins[newIdx] = coins[i];
                    }
                    coins = newCoins;
                }

                table.style.transition = 'none';
                table.style.transform = 'rotate(0deg)';
                setTimeout(() => {
                    table.style.transition = 'transform 0.8s ease';
                }, 50);

                hasViewed = false;
                isSpinning = false;

                updateSpinButton();
                checkWin();
            }, 1300);
        }

        function checkWin() {
            const allHeads = coins.every(c => c === true);
            const allTails = coins.every(c => c === false);

            if (allHeads || allTails) {
                visibleCoins = new Array(NUM_CUPS).fill(true);
                render();

                setTimeout(() => {
                    document.getElementById('final-moves').textContent = moves;
                    document.getElementById('win-overlay').classList.add('show');
                }, 500);
            }
        }

        function resetGame() {
            document.getElementById('win-overlay').classList.remove('show');
            init();
        }

        // 이벤트 리스너
        document.getElementById('btn-view-all').addEventListener('click', viewAll);
        document.getElementById('btn-view-adjacent').addEventListener('click', viewAdjacent);
        document.getElementById('btn-view-opposite').addEventListener('click', viewOpposite);
        document.getElementById('btn-view-custom').addEventListener('click', toggleCustomSelect);
        document.getElementById('btn-spin').addEventListener('click', spin);
        document.getElementById('btn-reset').addEventListener('click', resetGame);

        document.addEventListener('keydown', (e) => {
            if (e.code === 'KeyR' && !e.ctrlKey) {
                e.preventDefault();
                if (hasViewed && !isSpinning && !isSelectMode) {
                    spin();
                }
            }
        });

        // 언어 지원
        const translations = {
            en: {
                moveLabel: 'Moves',
                legendYou: 'You (2)',
                legendFriend: 'Friend (2)',
                viewAll: 'View All',
                viewAdjacent: 'Adjacent',
                viewOpposite: 'Opposite',
                viewCustom: 'Custom',
                confirm: 'Confirm',
                spin: 'Spin (R)',
                reset: 'Reset',
                congrats: 'Congratulations!',
                winMsg: 'All coins are now the same!',
                winMoves: 'You succeeded in',
                winMovesEnd: 'moves.',
                playAgain: 'Play Again',
                selectPrompt: 'Click 4 cups to select (Selected: 0/4)',
                selected: 'Selected:',
                selectOf: '/4',
                pleaseSelect4: 'Please select 4 cups!'
            },
            kr: {
                moveLabel: '이동 횟수',
                legendYou: '나 (2개)',
                legendFriend: '친구 (2개)',
                viewAll: '전체보기',
                viewAdjacent: '인접보기',
                viewOpposite: '마주보기',
                viewCustom: '직접선택',
                confirm: '확인',
                spin: '돌리기 (R)',
                reset: '초기화',
                congrats: '축하합니다!',
                winMsg: '모든 동전을 같은 색으로 만들었습니다!',
                winMoves: '총',
                winMovesEnd: '번의 이동으로 성공했습니다.',
                playAgain: '다시 하기',
                selectPrompt: '4개의 컵을 클릭하여 선택하세요 (선택됨: 0/4개)',
                selected: '선택됨:',
                selectOf: '/4개',
                pleaseSelect4: '4개를 선택해주세요!'
            }
        };

        let currentLang = 'kr';

        function updateLanguageTexts() {
            const t = translations[currentLang];

            document.getElementById('move-label').textContent = t.moveLabel;
            document.getElementById('legend-you').textContent = t.legendYou;
            document.getElementById('legend-friend').textContent = t.legendFriend;
            document.getElementById('btn-view-all').textContent = t.viewAll;
            document.getElementById('btn-view-adjacent').textContent = t.viewAdjacent;
            document.getElementById('btn-view-opposite').textContent = t.viewOpposite;

            // 직접선택 버튼은 상태에 따라 다르게
            if (!isSelectMode) {
                document.getElementById('btn-view-custom').textContent = t.viewCustom;
            } else {
                document.getElementById('btn-view-custom').textContent = t.confirm;
            }

            document.getElementById('btn-spin').textContent = t.spin;
            document.getElementById('btn-reset').textContent = t.reset;

            // 승리 메시지
            document.querySelector('.win-message h2').textContent = t.congrats;
            document.querySelector('.win-message p:nth-child(2)').textContent = t.winMsg;

            const movesText = document.querySelector('.win-message p:nth-child(3)');
            const finalMoves = document.getElementById('final-moves').textContent;
            movesText.innerHTML = `${t.winMoves} <span id="final-moves">${finalMoves}</span> ${t.winMovesEnd}`;

            document.querySelector('.win-message button').textContent = t.playAgain;
        }

        function setLang(lang) {
            currentLang = lang;
            updateLanguageTexts();
        }

        // 부모 창에서 언어 변경 메시지 수신
        window.addEventListener('message', (e) => {
            if (e.data && e.data.type === 'setLang') {
                setLang(e.data.lang);
            }
        });

        // localStorage에서 언어 설정 읽기
        const savedLang = localStorage.getItem('sumac-lang');
        if (savedLang) {
            currentLang = savedLang;
        }

        // 초기화
        createCups();
        init();
        updateLanguageTexts();
    </script>
</body>
</html>
